import asyncio
import logging
import os
from collections import Counter
from typing import Dict

from aiogram import Bot, Dispatcher, F, types
from aiogram.filters import Command, CommandStart
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup
from aiohttp import web

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –¢–æ–∫–µ–Ω –±–µ—Ä–µ—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (–Ω–∞ Render –∑–∞–¥–∞–¥–∏—Ç–µ –ø–æ–∑–∂–µ)
BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ –∑–∞–¥–∞–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")

# –°—Å—ã–ª–∫–∏ (—Ç–æ–∂–µ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
CHANNEL_LINK = os.getenv("CHANNEL_LINK", "https://t.me/+0Isqta1EjaFmNTVi")
PRODUCT_ENERGY_LINK = os.getenv("PRODUCT_ENERGY_LINK", "https://golnk.ru/d1VQ6")
PRODUCT_CARD_LINK = os.getenv("PRODUCT_CARD_LINK", "https://golnk.ru/kyZdE")

# –°–æ–∑–¥–∞–µ–º –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä
bot = Bot(token=BOT_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)


# --- –°–æ—Å—Ç–æ—è–Ω–∏—è FSM ---
class TestStates(StatesGroup):
    q1 = State()
    q2 = State()
    q3 = State()
    q4 = State()
    q5 = State()
    q6 = State()
    q7 = State()
    finished = State()


# --- –¢–µ–∫—Å—Ç—ã –≤–æ–ø—Ä–æ—Å–æ–≤ ---
QUESTIONS = [
    {
        "text": "–í–æ–ø—Ä–æ—Å 1. –ö–∞–∫ —Ç—ã —á–∞—â–µ –≤—Å–µ–≥–æ —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–µ–±—è —É—Ç—Ä–æ–º –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –¥–Ω—è?\n\n"
                "–ê) –ü—Ä–æ—Å—ã–ø–∞—é—Å—å —É–∂–µ —É—Å—Ç–∞–≤—à–µ–π. –•–æ—á–µ—Ç—Å—è –Ω–∞–∫—Ä—ã—Ç—å—Å—è –æ–¥–µ—è–ª–æ–º –∏ –Ω–∏–∫—É–¥–∞ –Ω–µ –∏–¥—Ç–∏.\n"
                "–ë) –°–º–µ—à–∞–Ω–Ω—ã–µ —á—É–≤—Å—Ç–≤–∞: –≤—Ä–æ–¥–µ –∏ —Ö–æ—á–µ—Ç—Å—è —á—Ç–æ-—Ç–æ –¥–µ–ª–∞—Ç—å, –Ω–æ –Ω–µ –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ –∏–º–µ–Ω–Ω–æ.\n"
                "–í) –ü—Ä–æ—Å—ã–ø–∞—é—Å—å —Å –æ—â—É—â–µ–Ω–∏–µ–º, —á—Ç–æ –Ω–∞–¥–æ —Å—Ä–æ—á–Ω–æ —á—Ç–æ-—Ç–æ –º–µ–Ω—è—Ç—å, –Ω–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ, —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å.\n"
                "–ì) –ü—Ä–æ—Å—ã–ø–∞—é—Å—å —Å –ª—ë–≥–∫–æ—Å—Ç—å—é, –ø—Ä–µ–¥–≤–∫—É—à–∞—é –Ω–æ–≤—ã–π –¥–µ–Ω—å, –¥–∞–∂–µ –µ—Å–ª–∏ –≤–ø–µ—Ä–µ–¥–∏ –º–Ω–æ–≥–æ –¥–µ–ª.",
        "options": ("A", "B", "C", "D")
    },
    {
        "text": "–í–æ–ø—Ä–æ—Å 2. –ï—Å–ª–∏ –ø–æ–¥—É–º–∞—Ç—å –æ –±–ª–∏–∂–∞–π—à–µ–º –±—É–¥—É—â–µ–º (–ø–æ–ª–≥–æ–¥–∞-–≥–æ–¥), —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å?\n\n"
                "–ê) –ë—É–¥—É—â–µ–µ –∫–∞–∂–µ—Ç—Å—è —Ç—É–º–∞–Ω–Ω—ã–º, —è —Å—Ç–∞—Ä–∞—é—Å—å –Ω–µ –∑–∞–≥–ª—è–¥—ã–≤–∞—Ç—å —Ç—É–¥–∞, –∂–∏–≤—É —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º –¥–Ω—ë–º.\n"
                "–ë) –ï—Å—Ç—å –º–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –Ω–æ —è –Ω–µ –∑–Ω–∞—é, –∫–∞–∫–æ–π –≤—ã–±—Ä–∞—Ç—å, –±–æ—é—Å—å –æ—à–∏–±–∏—Ç—å—Å—è.\n"
                "–í) –ß—É–≤—Å—Ç–≤—É—é, —á—Ç–æ —Ç–∞–∫ –¥–∞–ª—å—à–µ –Ω–µ–ª—å–∑—è, –Ω–æ —Å—Ç–∞—Ä—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —É–∂–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∞ –Ω–æ–≤—ã–π –µ—â—ë –Ω–µ —Ä–æ–¥–∏–ª—Å—è.\n"
                "–ì) –Ø —Å–º–æ—Ç—Ä—é –≤ –±—É–¥—É—â–µ–µ —Å –∏–Ω—Ç–µ—Ä–µ—Å–æ–º –∏ –æ–ø—Ç–∏–º–∏–∑–º–æ–º, —É –º–µ–Ω—è –µ—Å—Ç—å –ø–ª–∞–Ω—ã –∏ —Ü–µ–ª–∏.",
        "options": ("A", "B", "C", "D")
    },
    {
        "text": "–í–æ–ø—Ä–æ—Å 3. –ö–∞–∫ —Ç—ã –ø—Ä–∏–Ω–∏–º–∞–µ—à—å —Ä–µ—à–µ–Ω–∏—è –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è?\n\n"
                "–ê) –ú–Ω–µ —Å–ª–æ–∂–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –¥–∞–∂–µ –º–∞–ª–µ–Ω—å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è. –ó–∞–≤–∏—Å–∞—é –Ω–∞–¥ –≤—ã–±–æ—Ä–æ–º –±–ª—é–¥–∞ –≤ –∫–∞—Ñ–µ.\n"
                "–ë) –ú–µ—á—É—Å—å –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏, —Å–µ–≥–æ–¥–Ω—è –æ–¥–Ω–æ –∫–∞–∂–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º, –∑–∞–≤—Ç—Ä–∞ ‚Äî –¥—Ä—É–≥–æ–µ.\n"
                "–í) –û—Ç–∫–∞–∑—ã–≤–∞—é—Å—å –æ—Ç —Ä–µ—à–µ–Ω–∏–π, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ ¬´–≤—Å—ë –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ¬ª.\n"
                "–ì) –Ø –ø—Ä–∏–Ω–∏–º–∞—é —Ä–µ—à–µ–Ω–∏—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–µ–≥–∫–æ, –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ —Å–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞ –∏ —Ä–∞–∑—É–º.",
        "options": ("A", "B", "C", "D")
    },
    {
        "text": "–í–æ–ø—Ä–æ—Å 4. –ß—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å, –∫–æ–≥–¥–∞ –¥—É–º–∞–µ—à—å –æ —Å–≤–æ–∏—Ö –∂–µ–ª–∞–Ω–∏—è—Ö?\n\n"
                "–ê) –Ø –Ω–µ –∑–Ω–∞—é, —á–µ–≥–æ —Ö–æ—á—É. –°–æ–≤—Å–µ–º. –ö–∞–∫ –æ—Ç—Ä–µ–∑–∞–ª–æ.\n"
                "–ë) –•–æ—á–µ—Ç—Å—è –º–Ω–æ–≥–æ–≥–æ, –Ω–æ —è –Ω–µ —Ä–∞–∑—Ä–µ—à–∞—é —Å–µ–±–µ —ç—Ç–æ–≥–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ ¬´–Ω–∞–¥–æ –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∫–æ–π¬ª.\n"
                "–í) –ñ–µ–ª–∞–Ω–∏—è –µ—Å—Ç—å, –Ω–æ –æ–Ω–∏ –∫–∞–∂—É—Ç—Å—è ¬´–Ω–µ –º–æ–∏–º–∏¬ª ‚Äî —Å–ª–æ–≤–Ω–æ –Ω–∞–≤—è–∑–∞–Ω–Ω—ã–º–∏.\n"
                "–ì) –Ø —Ö–æ—Ä–æ—à–æ –∑–Ω–∞—é, —á–µ–≥–æ —Ö–æ—á—É, –∏ –º–æ–∏ –∂–µ–ª–∞–Ω–∏—è –º–Ω–µ –±–ª–∏–∑–∫–∏ –∏ –ø–æ–Ω—è—Ç–Ω—ã.",
        "options": ("A", "B", "C", "D")
    },
    {
        "text": "–í–æ–ø—Ä–æ—Å 5. –ö–∞–∫–∞—è —Ñ—Ä–∞–∑–∞ —á–∞—â–µ –∑–≤—É—á–∏—Ç –≤ —Ç–≤–æ–µ–π –≥–æ–ª–æ–≤–µ?\n\n"
                "–ê) ¬´–Ø —É—Å—Ç–∞–ª–∞. –û—Å—Ç–∞–≤—å—Ç–µ –º–µ–Ω—è –≤ –ø–æ–∫–æ–µ¬ª.\n"
                "–ë) ¬´–ù–∞–¥–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å—Å—è, –Ω–æ –∫–∞–∫?¬ª\n"
                "–í) ¬´–í—Å—ë –Ω–∞–¥–æ–µ–ª–æ. –•–æ—á—É –ø–æ-–¥—Ä—É–≥–æ–º—É, –Ω–æ –Ω–µ –∑–Ω–∞—é –∫–∞–∫¬ª.\n"
                "–ì) ¬´–£ –º–µ–Ω—è –≤—Å—ë —Ö–æ—Ä–æ—à–æ, —è —Å–ø—Ä–∞–≤–ª—è—é—Å—å¬ª.",
        "options": ("A", "B", "C", "D")
    },
    {
        "text": "–í–æ–ø—Ä–æ—Å 6. –ß—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å –≤ —Ç–µ–ª–µ —á–∞—â–µ –≤—Å–µ–≥–æ?\n\n"
                "–ê) –¢—è–∂–µ—Å—Ç—å, –∑–∞–∂–∞—Ç–æ—Å—Ç—å, –Ω–µ–∂–µ–ª–∞–Ω–∏–µ –¥–≤–∏–≥–∞—Ç—å—Å—è.\n"
                "–ë) –ë–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ, –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –¥—Ä–æ–∂—å, –∫–æ–º –≤ –≥–æ—Ä–ª–µ.\n"
                "–í) –ü—É—Å—Ç–æ—Ç—É, –æ–Ω–µ–º–µ–Ω–∏–µ, ¬´—Ç–µ–ª–∞ –Ω–µ —á—É–≤—Å—Ç–≤—É—é¬ª.\n"
                "–ì) –õ—ë–≥–∫–æ—Å—Ç—å, —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω–æ—Å—Ç—å –∏–ª–∏ –∑–¥–æ—Ä–æ–≤—ã–π —Ç–æ–Ω—É—Å.",
        "options": ("A", "B", "C", "D")
    },
    {
        "text": "–í–æ–ø—Ä–æ—Å 7. –ï—Å–ª–∏ –±—ã —É —Ç–µ–±—è –±—ã–ª–∞ –≤–æ–ª—à–µ–±–Ω–∞—è –ø–∞–ª–æ—á–∫–∞, —á—Ç–æ –±—ã —Ç—ã –∏–∑–º–µ–Ω–∏–ª–∞ –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?\n\n"
                "–ê) –ù–∏—á–µ–≥–æ. –Ø –Ω–µ –≤–µ—Ä—é, —á—Ç–æ —á—Ç–æ-—Ç–æ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å.\n"
                "–ë) –Ø –±—ã –ø–æ–Ω—è–ª–∞ –Ω–∞–∫–æ–Ω–µ—Ü, –∫—É–¥–∞ –∏–¥—Ç–∏ –∏ –∫–∞–∫–æ–π –ø—É—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π.\n"
                "–í) –Ø –±—ã —Å—Ç–µ—Ä–ª–∞ –≤—Å—é —Å–≤–æ—é –ø—Ä–æ—à–ª—É—é –∂–∏–∑–Ω—å –∏ –Ω–∞—á–∞–ª–∞ —Å –Ω—É–ª—è.\n"
                "–ì) –Ø –±—ã –æ—Å—Ç–∞–≤–∏–ª–∞ –≤—Å—ë –∫–∞–∫ –µ—Å—Ç—å, –º–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –º–æ—è –∂–∏–∑–Ω—å.",
        "options": ("A", "B", "C", "D")
    },
]


# --- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã ---
def get_start_keyboard() -> InlineKeyboardMarkup:
    buttons = [
        [InlineKeyboardButton(text="‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç", callback_data="start_test")],
        [InlineKeyboardButton(text="‚ùì –ó–∞—á–µ–º —ç—Ç–æ", callback_data="why_info")],
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def get_why_keyboard() -> InlineKeyboardMarkup:
    buttons = [
        [InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_start")],
        [InlineKeyboardButton(text="‚ñ∂Ô∏è –í—Å—ë —Ä–∞–≤–Ω–æ –Ω–∞—á–∞—Ç—å", callback_data="start_test")],
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def get_question_keyboard(question_index: int, show_back: bool = False) -> InlineKeyboardMarkup:
    buttons = [
        [InlineKeyboardButton(text="üÖ∞ –ê", callback_data="answer_A"),
         InlineKeyboardButton(text="üÖ± –ë", callback_data="answer_B")],
        [InlineKeyboardButton(text="üÖ≤ –í", callback_data="answer_C"),
         InlineKeyboardButton(text="üÖ≥ –ì", callback_data="answer_D")],
    ]
    if show_back:
        buttons.append([InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back")])
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def get_result_keyboard(result_type: str) -> InlineKeyboardMarkup:
    buttons = []
    if result_type in ("A", "mixed"):
        buttons.append([InlineKeyboardButton(text="üåø –£–∑–Ω–∞—Ç—å –æ –ø—Ä–∞–∫—Ç–∏–∫–µ ¬´–≠–Ω–µ—Ä–≥–∏—è –∂–∏–∑–Ω–∏¬ª", url=PRODUCT_ENERGY_LINK)])
    if result_type in ("B", "C", "mixed"):
        buttons.append([InlineKeyboardButton(text="üÉè –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –º–∏–Ω–∏-—Ä–∞–∑–±–æ—Ä –ø–æ –∫–∞—Ä—Ç–µ", url=PRODUCT_CARD_LINK)])
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def get_channel_keyboard() -> InlineKeyboardMarkup:
    buttons = [[InlineKeyboardButton(text="üì± –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞–Ω–∞–ª –Æ–ª–∏–∏", url=CHANNEL_LINK)]]
    return InlineKeyboardMarkup(inline_keyboard=buttons)


# --- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ---
def determine_result(answers: Dict[int, str]) -> str:
    count = Counter(answers.values())
    for t in ("A", "B", "C", "D"):
        if count.get(t, 0) >= 4:
            return t
    return "mixed"


def get_result_text(result_type: str) -> str:
    if result_type == "A":
        return (
            "üåü *–¢—ã –≤ —Ä–µ–∂–∏–º–µ –ø–∞—É–∑—ã*\n\n"
            "–°–µ–π—á–∞—Å —Ç—ã –ø–æ—Ö–æ–∂–∞ –Ω–∞ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑—Ä—è–¥–∏–ª—Å—è. –¢—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–ª–∞ ‚Äî —Ç—ã –∏—Å—Ç–æ—â–µ–Ω–∞. –û—Ä–≥–∞–Ω–∏–∑–º –≤–∫–ª—é—á–∏–ª –∑–∞—â–∏—Ç–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º: –æ–Ω —Ç–æ—Ä–º–æ–∑–∏—Ç –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã, —á—Ç–æ–±—ã —Ç—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å –∏ –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –æ—Ç–¥–æ—Ö–Ω—É–ª–∞.\n\n"
            "–í –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏ —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–ª–∏–∑–∫–æ –∫ ¬´—Å–∏–Ω–¥—Ä–æ–º—É —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–ª–æ—Å—Ç–∏¬ª –∏–ª–∏ –∞—Å—Ç–µ–Ω–∏—á–µ—Å–∫–æ–º—É —Å–∏–Ω–¥—Ä–æ–º—É. –¢–≤–æ—è –Ω–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ, –∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ, —á—Ç–æ –µ–π —Å–µ–π—á–∞—Å –Ω—É–∂–Ω–æ ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø–æ–∫–æ–π.\n\n"
            "–ß—Ç–æ –≤–∞–∂–Ω–æ –ø–æ–Ω—è—Ç—å:\n"
            "–ü–∞—É–∑–∞ ‚Äî —ç—Ç–æ –Ω–µ —Å–ª–∞–±–æ—Å—Ç—å –∏ –Ω–µ –ª–µ–Ω—å. –≠—Ç–æ —Å–∏–≥–Ω–∞–ª SOS –æ—Ç —Ç–≤–æ–µ–≥–æ –æ—Ä–≥–∞–Ω–∏–∑–º–∞. –í —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ —Å–µ–±—è –ø–æ–¥–≥–æ–Ω—è—Ç—å, —Å—Ç–∞–≤–∏—Ç—å —Ü–µ–ª–∏ –∏ ¬´–±—Ä–∞—Ç—å —Å–µ–±—è –≤ —Ä—É–∫–∏¬ª. –≠—Ç–æ —Ç–æ–ª—å–∫–æ —É—Å—É–≥—É–±–∏—Ç –∏—Å—Ç–æ—â–µ–Ω–∏–µ.\n\n"
            "–ß—Ç–æ —Å–µ–π—á–∞—Å –Ω—É–∂–Ω–æ —Ç–≤–æ–µ–º—É –æ—Ä–≥–∞–Ω–∏–∑–º—É:\n"
            "‚Äî –†–µ–∞–ª—å–Ω—ã–π –æ—Ç–¥—ã—Ö (–Ω–µ ¬´—Å–º–µ–Ω–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏¬ª, –∞ –∏–º–µ–Ω–Ω–æ –ø–æ–∫–æ–π)\n"
            "‚Äî –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≤ —Ç–µ–ª–æ (–∑–∞–∑–µ–º–ª–µ–Ω–∏–µ, —Å–µ–Ω—Å–æ—Ä–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏)\n"
            "‚Äî –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏ –¥–µ–¥–ª–∞–π–Ω–æ–≤\n\n"
            "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n\n"
            "–¢–µ–±–µ –ø–æ–¥–æ–π–¥—ë—Ç –º—è–≥–∫–æ–µ, –±–µ—Ä–µ–∂–Ω–æ–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∫ —Å–µ–±–µ. –ë–µ–∑ —Ä—ã–≤–∫–æ–≤, –±–µ–∑ –ø–ª–∞–Ω–æ–≤, –±–µ–∑ ¬´–Ω–∞–¥–æ¬ª.\n\n"
            "üëâ *–ü—Ä–∞–∫—Ç–∏–∫–∞ ¬´–≠–Ω–µ—Ä–≥–∏—è –∂–∏–∑–Ω–∏¬ª (7 –¥–Ω–µ–π)* —Å–æ–∑–¥–∞–Ω–∞ –∏–º–µ–Ω–Ω–æ –¥–ª—è —Ç–∞–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è. –ú—ã –Ω–µ —Å—Ç–∞–≤–∏–º —Ü–µ–ª–∏, –Ω–µ —Ç—Ä–µ–±—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –ú—ã –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç —Å —Ç–µ–ª–æ–º, —Å —á—É–≤—Å—Ç–≤–∞–º–∏, —Å –∂–∏–∑–Ω—å—é ‚Äî –ø–æ –∫–∞–ø–ª–µ, –¥–µ–Ω—å –∑–∞ –¥–Ω—ë–º."
        )
    elif result_type == "B":
        return (
            "üåÄ *–¢—ã –≤ —Ä–µ–∂–∏–º–µ –ø–æ–∏—Å–∫–∞*\n\n"
            "–¢—ã –º–µ—á–µ—à—å—Å—è –º–µ–∂–¥—É –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ö–æ—á–µ—à—å –Ω–∞–π—Ç–∏ ¬´—Ç–æ—Ç —Å–∞–º—ã–π¬ª, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å. –¢—ã —á—É–≤—Å—Ç–≤—É–µ—à—å, —á—Ç–æ –µ—Å—Ç—å –º–Ω–æ–≥–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π, –Ω–æ —Å—Ç—Ä–∞—Ö –æ—à–∏–±–∫–∏ –ø–∞—Ä–∞–ª–∏–∑—É–µ—Ç –≤—ã–±–æ—Ä. –¢–≤–æ–π –º–æ–∑–≥ –ø–µ—Ä–µ–≥—Ä–µ–≤–∞–µ—Ç—Å—è –æ—Ç –ø–µ—Ä–µ–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –∞ —Å–µ—Ä–¥—Ü–µ –º–æ–ª—á–∏—Ç.\n\n"
            "–í –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏ —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞–∑—ã–≤–∞—é—Ç ¬´–¥–∏—Ñ—Ñ—É–∑–∏–µ–π –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏¬ª –∏–ª–∏ –∫—Ä–∏–∑–∏—Å–æ–º –≤—ã–±–æ—Ä–∞. –¢—ã –∏—â–µ—à—å –≤–æ–≤–Ω–µ —Ç–æ, —á—Ç–æ –º–æ–∂–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–≤–æ—ë –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ ¬´—è¬ª. –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –∞ –≤ –ø–æ—Ç–µ—Ä–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ –≤—ã–±–æ—Ä–∞.\n\n"
            "–ß—Ç–æ –≤–∞–∂–Ω–æ –ø–æ–Ω—è—Ç—å:\n"
            "–¢—ã –Ω–µ –º–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å –Ω–µ –ø–æ—Ç–æ–º—É, —á—Ç–æ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–ª–æ—Ö–∏–µ. –ê –ø–æ—Ç–æ–º—É, —á—Ç–æ –Ω–µ —Å–ª—ã—à–∏—à—å —Å–µ–±—è. –¢—ã –ø—Ä–∏–≤—ã–∫–ª–∞ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ ¬´–∫–∞–∫ –Ω–∞–¥–æ¬ª, ¬´–∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ¬ª, ¬´–∫–∞–∫ —É –¥—Ä—É–≥–∏—Ö¬ª ‚Äî –∏ –ø–æ—Ç–µ—Ä—è–ª–∞ —Å–≤–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–º–ø–∞—Å.\n\n"
            "–ß—Ç–æ —Å–µ–π—á–∞—Å –Ω—É–∂–Ω–æ:\n"
            "‚Äî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π –ø–µ—Ä–µ–±–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤\n"
            "‚Äî –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–≤–æ–∏–º –∏—Å—Ç–∏–Ω–Ω—ã–º —Ü–µ–Ω–Ω–æ—Å—Ç—è–º\n"
            "‚Äî –£—Å–ª—ã—à–∞—Ç—å, —á–µ–≥–æ —Ö–æ—á–µ—à—å –∏–º–µ–Ω–Ω–æ —Ç—ã, –∞ –Ω–µ ¬´–≤—Å–µ¬ª\n\n"
            "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n\n"
            "–¢–µ–±–µ –Ω—É–∂–µ–Ω –Ω–µ –Ω–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –∞ –≤—Å—Ç—Ä–µ—á–∞ —Å —Å–æ–±–æ–π. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç —É—Å–ª—ã—à–∞—Ç—å —Å–≤–æ–π –≥–æ–ª–æ—Å –∑–∞ —Ö–æ—Ä–æ–º —á—É–∂–∏—Ö –º–Ω–µ–Ω–∏–π.\n\n"
            "üëâ *–ú–∏–Ω–∏-—Ä–∞–∑–±–æ—Ä –ø–æ 1 –∫–∞—Ä—Ç–µ (30‚Äì40 –º–∏–Ω—É—Ç)* ‚Äî —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤ —Ç–∏—à–∏–Ω–µ –∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —É–≤–∏–¥–µ—Ç—å, –∫—É–¥–∞ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —Ö–æ—á–µ—à—å —Ç—ã. –û–¥–Ω–∞ –∫–∞—Ä—Ç–∞, –æ–¥–∏–Ω —á–µ—Å—Ç–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä, –∏ —á–∞—Å—Ç–æ —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á—Ç–æ–±—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—è—Å–Ω–∏–ª–æ—Å—å."
        )
    elif result_type == "C":
        return (
            "üîÑ *–¢—ã –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞*\n\n"
            "–¢—ã —á—É–≤—Å—Ç–≤—É–µ—à—å, —á—Ç–æ —Å—Ç–∞—Ä—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∏—Å—á–µ—Ä–ø–∞–Ω. –¢–æ, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ —Ä–∞–Ω—å—à–µ, –±–æ–ª—å—à–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –û—Ç–Ω–æ—à–µ–Ω–∏—è, —Ä–∞–±–æ—Ç–∞, –ø—Ä–∏–≤—ã—á–Ω—ã–π —É–∫–ª–∞–¥ ‚Äî –≤—Å—ë –±—É–¥—Ç–æ —Å–∂–∏–º–∞–µ—Ç—Å—è, –ø–æ–¥—Ç–∞–ª–∫–∏–≤–∞—è —Ç–µ–±—è –∫ –ø–µ—Ä–µ–º–µ–Ω–∞–º. –ù–æ –Ω–æ–≤–æ–µ –µ—â—ë –Ω–µ —Ä–æ–¥–∏–ª–æ—Å—å, –∏ —Ç—ã –≤ –ø–æ–¥–≤–µ—à–µ–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.\n\n"
            "–í –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏ —ç—Ç–æ –Ω–∞–∑—ã–≤–∞—é—Ç ¬´—ç–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º –∫—Ä–∏–∑–∏—Å–æ–º¬ª –∏–ª–∏ —Ç–æ—á–∫–æ–π –±–∏—Ñ—É—Ä–∫–∞—Ü–∏–∏ ‚Äî –º–æ–º–µ–Ω—Ç–æ–º, –∫–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –ª–∏–±–æ —Ä–∞–∑—Ä—É—à–∏—Ç—å—Å—è, –ª–∏–±–æ –≤—ã–π—Ç–∏ –Ω–∞ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å. –≠—Ç–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å—Ç—Ä–∞—à–Ω–æ –∏ —Ü–µ–Ω–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∑–¥–µ—Å—å —Ä–æ–∂–¥–∞—é—Ç—Å—è —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∂–∏–∑–Ω–∏.\n\n"
            "–ß—Ç–æ –≤–∞–∂–Ω–æ –ø–æ–Ω—è—Ç—å:\n"
            "–†–∞–∑–≤–æ—Ä–æ—Ç ‚Äî —ç—Ç–æ –Ω–µ –∫–æ–Ω–µ—Ü. –≠—Ç–æ –Ω–∞—á–∞–ª–æ. –¢—ã –Ω–µ —Å–ª–æ–º–∞–Ω–∞, —Ç—ã –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∞—Å—Ç–∞–µ—à—å —Å–≤–æ—é —Å—Ç–∞—Ä—É—é –∂–∏–∑–Ω—å. –ö–∞–∫ –∑–º–µ—è, –∫–æ—Ç–æ—Ä–æ–π —Ç–µ—Å–Ω–∞ —Å—Ç–∞—Ä–∞—è –∫–æ–∂–∞. –î–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ, –Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.\n\n"
            "–ß—Ç–æ —Å–µ–π—á–∞—Å –Ω—É–∂–Ω–æ:\n"
            "‚Äî –ü—Ä–∏–∑–Ω–∞—Ç—å, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Å—Ç–∞—Ä–æ–º—É –Ω–µ—Ç\n"
            "‚Äî –†–∞–∑—Ä–µ—à–∏—Ç—å —Å–µ–±–µ —Ö–æ—Ç–µ—Ç—å –ø–æ-–Ω–æ–≤–æ–º—É\n"
            "‚Äî –ù–∞–π—Ç–∏ –æ–ø–æ—Ä—É –≤ —Å–∞–º–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π\n\n"
            "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n\n"
            "–¢–µ–±–µ –Ω—É–∂–µ–Ω –ø—Ä–æ–≤–æ–¥–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—É–¥–µ—Ç —Ç—è–Ω—É—Ç—å –Ω–∞–∑–∞–¥ –∏–ª–∏ —Ç–æ–ª–∫–∞—Ç—å –≤–ø–µ—Ä—ë–¥, –∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–±—É–¥–µ—Ç —Ä—è–¥–æ–º –≤ —ç—Ç–æ–º —Ä–∞–∑–≤–æ—Ä–æ—Ç–µ. –ò –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –Ω–æ–≤–æ–º—É –ø—Ä–æ—è–≤–∏—Ç—å—Å—è –º—è–≥–∫–æ, –±–µ–∑ –Ω–∞—Å–∏–ª–∏—è.\n\n"
            "üëâ *–ü—Ä–∞–∫—Ç–∏–∫–∞ ¬´–≠–Ω–µ—Ä–≥–∏—è –∂–∏–∑–Ω–∏¬ª (7 –¥–Ω–µ–π)* —Å—Ç–∞–Ω–µ—Ç –±–µ—Ä–µ–∂–Ω–æ–π –æ–ø–æ—Ä–æ–π –≤ —ç—Ç–æ–º –ø–µ—Ä–µ—Ö–æ–¥–µ. –ê –µ—Å–ª–∏ —Ö–æ—á–µ—Ç—Å—è –≥–ª—É–±–∏–Ω—ã –∏ –ª–∏—á–Ω–æ–≥–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è ‚Äî –º–∏–Ω–∏-—Ä–∞–∑–±–æ—Ä –ø–æ –∫–∞—Ä—Ç–µ –ø–æ–º–æ–∂–µ—Ç —É–≤–∏–¥–µ—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ –∏ –ø–µ—Ä–≤—ã–π —à–∞–≥."
        )
    elif result_type == "D":
        return (
            "‚ú® *–¢—ã –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≥–∞—Ä–º–æ–Ω–∏–∏*\n\n"
            "–¢—ã —á—É–≤—Å—Ç–≤—É–µ—à—å –±–∞–ª–∞–Ω—Å –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å. –£ —Ç–µ–±—è –µ—Å—Ç—å —ç–Ω–µ—Ä–≥–∏—è, —Ç—ã –∑–Ω–∞–µ—à—å, —á–µ–≥–æ —Ö–æ—á–µ—à—å, –∏ —Ç–≤–æ–∏ –∂–µ–ª–∞–Ω–∏—è —Å–æ–∑–≤—É—á–Ω—ã —Å —Ç–≤–æ–∏–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏. –≠—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤–∞–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å.\n\n"
            "–ß—Ç–æ –≤–∞–∂–Ω–æ –ø–æ–Ω—è—Ç—å:\n"
            "–ì–∞—Ä–º–æ–Ω–∏—è ‚Äî –Ω–µ —Å—Ç–∞—Ç–∏—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –∞ –∂–∏–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å. –ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≤ –Ω—ë–º, –Ω—É–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ø—Ä–∏—Å–ª—É—à–∏–≤–∞—Ç—å—Å—è –∫ —Å–µ–±–µ, –∑–∞–º–µ—á–∞—Ç—å —Å–≤–æ–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∏ –≤–æ–≤—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞—Ç—å.\n\n"
            "–ß—Ç–æ —Å–µ–π—á–∞—Å –Ω—É–∂–Ω–æ:\n"
            "‚Äî –†–∞–¥–æ–≤–∞—Ç—å—Å—è —Ç–æ–º—É, —á—Ç–æ –µ—Å—Ç—å\n"
            "‚Äî –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å–≤—è–∑—å —Å —Å–æ–±–æ–π —á–µ—Ä–µ–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏\n"
            "‚Äî –î–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Å –±–ª–∏–∑–∫–∏–º–∏\n\n"
            "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n\n"
            "–¢—ã —É–∂–µ –≤ –ø–æ—Ä—è–¥–∫–µ. –ù–æ –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —É–≥–ª—É–±–∏—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Å–µ–±—è –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –±—ã—Ç—å –≤ –∫—Ä—É–≥—É –µ–¥–∏–Ω–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫–æ–≤ ‚Äî –∑–∞—Ö–æ–¥–∏ –≤ Telegram-–∫–∞–Ω–∞–ª, —Ç–∞–º —è –¥–µ–ª—é—Å—å –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏ –∏ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è–º–∏ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ö–æ—á–µ—Ç –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≤ –∫–æ–Ω—Ç–∞–∫—Ç–µ —Å —Å–æ–±–æ–π."
        )
    else:  # mixed
        return (
            "üö¶ *–¢—ã –Ω–∞ –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–∫–µ*\n\n"
            "–°–µ–π—á–∞—Å —Ç—ã —Å–æ—á–µ—Ç–∞–µ—à—å –≤ —Å–µ–±–µ —Ä–∞–∑–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ñ–∏–∑–Ω—å —Ä–µ–¥–∫–æ —É–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ –æ–¥–Ω—É –∫–æ—Ä–æ–±–æ—á–∫—É. –í–∞–∂–Ω–æ, —á—Ç–æ —Ç—ã —É–∂–µ –æ–±—Ä–∞—Ç–∏–ª–∞ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å–µ–±—è –∏ –≥–æ—Ç–æ–≤–∞ —á—Ç–æ-—Ç–æ –º–µ–Ω—è—Ç—å.\n\n"
            "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:\n\n"
            "–ü—Ä–∏—Å–ª—É—à–∞–π—Å—è –∫ —Å–µ–±–µ: —á–µ–≥–æ –±–æ–ª—å—à–µ —Ö–æ—á–µ—Ç—Å—è ‚Äî —Ç–∏—à–∏–Ω—ã –∏ –ø–æ–∫–æ—è –∏–ª–∏ —è—Å–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è? –û—Ç—Ç–∞–ª–∫–∏–≤–∞–π—Å—è –æ—Ç —ç—Ç–æ–≥–æ.\n\n"
            "üëâ *–ü—Ä–∞–∫—Ç–∏–∫–∞ ¬´–≠–Ω–µ—Ä–≥–∏—è –∂–∏–∑–Ω–∏¬ª* –¥–∞—Å—Ç —Ç–∏—à–∏–Ω—É –∏ –æ–ø–æ—Ä—É.\n"
            "üëâ *–ú–∏–Ω–∏-—Ä–∞–∑–±–æ—Ä –ø–æ –∫–∞—Ä—Ç–µ* –¥–∞—Å—Ç —è—Å–Ω–æ—Å—Ç—å –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.\n\n"
            "–í—ã–±–∏—Ä–∞–π —Ç–æ, —á—Ç–æ –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è —Å–µ–π—á–∞—Å."
        )


# --- –•—ç–Ω–¥–ª–µ—Ä—ã ---
@dp.message(CommandStart())
async def cmd_start(message: types.Message, state: FSMContext):
    await state.clear()
    await message.answer(
        "‚ú® *–Æ–ª–∏—è –í–∞–ª–µ–µ–≤–∞* ‚Äî –ø—Å–∏—Ö–æ–ª–æ–≥, –∏–≥—Ä–æ–ø—Ä–∞–∫—Ç–∏–∫\n\n"
        "üåü *–û —Ç–µ—Å—Ç–µ:*\n"
        "–í—Å–µ–≥–æ 7 –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–º–æ–≥—É—Ç –ø–æ–Ω—è—Ç—å, –≥–¥–µ —Ç—ã —Å–µ–π—á–∞—Å:\n"
        "üåÄ *–ü–∞—É–∑–∞* ‚Äî –∫–æ–≥–¥–∞ —Å–∏–ª—ã –Ω–∞ –Ω—É–ª–µ\n"
        "üîç *–ü–æ–∏—Å–∫* ‚Äî –∫–æ–≥–¥–∞ –Ω–µ –∑–Ω–∞–µ—à—å, –∫—É–¥–∞ –∏–¥—Ç–∏\n"
        "üîÑ *–†–∞–∑–≤–æ—Ä–æ—Ç* ‚Äî –∫–æ–≥–¥–∞ —Ö–æ—á–µ—à—å –ø–µ—Ä–µ–º–µ–Ω\n\n"
        "üëá *–ù–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç¬ª* ‚Äî —ç—Ç–æ –∑–∞–π–º—ë—Ç 3 –º–∏–Ω—É—Ç—ã. –û—Ç–≤–µ—á–∞–π –ø–µ—Ä–≤–æ–µ, —á—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –≥–æ–ª–æ–≤—É.",
        reply_markup=get_start_keyboard(),
        parse_mode="Markdown"
    )


@dp.callback_query(F.data == "why_info")
async def why_info(callback: types.CallbackQuery, state: FSMContext):
    await callback.message.edit_text(
        "–≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ:\n"
        "‚Äî –ø–æ–Ω—è—Ç—å, –Ω–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Ç—ã —Å–µ–π—á–∞—Å –Ω–∞—Ö–æ–¥–∏—à—å—Å—è\n"
        "‚Äî —É–≤–∏–¥–µ—Ç—å, –ø–æ—á–µ–º—É –ø—Ä–∏–≤—ã—á–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã ¬´—Ä–µ—à–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã¬ª –ø–µ—Ä–µ—Å—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å\n"
        "‚Äî –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É, –∫–∞–∫–æ–π —à–∞–≥ –±—É–¥–µ—Ç —Å–∞–º—ã–º —ç–∫–æ–ª–æ–≥–∏—á–Ω—ã–º –∏–º–µ–Ω–Ω–æ –¥–ª—è —Ç–µ–±—è",
        reply_markup=get_why_keyboard(),
    )
    await callback.answer()


@dp.callback_query(F.data == "back_to_start")
async def back_to_start(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    await callback.message.edit_text(
        "‚ú® *–Æ–ª–∏—è –í–∞–ª–µ–µ–≤–∞* ‚Äî –ø—Å–∏—Ö–æ–ª–æ–≥, –∏–≥—Ä–æ–ø—Ä–∞–∫—Ç–∏–∫\n\n"
        "üåü *–û —Ç–µ—Å—Ç–µ:*\n"
        "–í—Å–µ–≥–æ 7 –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–º–æ–≥—É—Ç –ø–æ–Ω—è—Ç—å, –≥–¥–µ —Ç—ã —Å–µ–π—á–∞—Å:\n"
        "üåÄ *–ü–∞—É–∑–∞* ‚Äî –∫–æ–≥–¥–∞ —Å–∏–ª—ã –Ω–∞ –Ω—É–ª–µ\n"
        "üîç *–ü–æ–∏—Å–∫* ‚Äî –∫–æ–≥–¥–∞ –Ω–µ –∑–Ω–∞–µ—à—å, –∫—É–¥–∞ –∏–¥—Ç–∏\n"
        "üîÑ *–†–∞–∑–≤–æ—Ä–æ—Ç* ‚Äî –∫–æ–≥–¥–∞ —Ö–æ—á–µ—à—å –ø–µ—Ä–µ–º–µ–Ω\n\n"
        "üëá *–ù–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç¬ª* ‚Äî —ç—Ç–æ –∑–∞–π–º—ë—Ç 3 –º–∏–Ω—É—Ç—ã. –û—Ç–≤–µ—á–∞–π –ø–µ—Ä–≤–æ–µ, —á—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –≥–æ–ª–æ–≤—É.",
        reply_markup=get_start_keyboard(),
        parse_mode="Markdown"
    )
    await callback.answer()


@dp.callback_query(F.data == "start_test")
async def start_test(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    await state.update_data(answers={})
    await state.set_state(TestStates.q1)
    await callback.message.edit_text(
        QUESTIONS[0]["text"],
        reply_markup=get_question_keyboard(0, show_back=False),
    )
    await callback.answer()


async def process_answer(callback: types.CallbackQuery, state: FSMContext, question_index: int, answer: str):
    data = await state.get_data()
    answers = data.get("answers", {})
    answers[question_index + 1] = answer
    await state.update_data(answers=answers)

    if question_index == len(QUESTIONS) - 1:
        result_type = determine_result(answers)
        result_text = get_result_text(result_type)

        await callback.message.edit_text("–°–ø–∞—Å–∏–±–æ –∑–∞ —á–µ—Å—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã! –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã... üîÑ")
        await asyncio.sleep(1)

        await callback.message.answer(
            result_text,
            parse_mode="Markdown",
            reply_markup=get_result_keyboard(result_type),
        )
        await callback.message.answer(
            "–Ø –Æ–ª–∏—è, –∞–≤—Ç–æ—Ä —ç—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞. –Ø –ø—Å–∏—Ö–æ–ª–æ–≥ –∏ –∏–≥—Ä–æ–ø—Ä–∞–∫—Ç–∏–∫, –∏ –º–æ—è —Ä–∞–±–æ—Ç–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –ª—é–¥—è–º –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –ø–∞—É–∑—ã, –ø–æ–∏—Å–∫–∏ –∏ —Ä–∞–∑–≤–æ—Ä–æ—Ç—ã –º—è–≥–∫–æ, –±–µ–∑ –Ω–∞—Å–∏–ª–∏—è –Ω–∞–¥ —Å–æ–±–æ–π.\n\n"
            "–í –º–æ—ë–º Telegram-–∫–∞–Ω–∞–ª–µ —è –¥–µ–ª—é—Å—å –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏, —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è–º–∏ –∏ –∞–Ω–æ–Ω—Å–∞–º–∏. –ü—Ä–∏—Ö–æ–¥–∏, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –±—ã—Ç—å –≤ –∫–æ–Ω—Ç–∞–∫—Ç–µ —Å —Å–æ–±–æ–π üí´",
            reply_markup=get_channel_keyboard(),
        )
        await state.set_state(TestStates.finished)
    else:
        next_q = question_index + 1
        await state.set_state(getattr(TestStates, f"q{next_q+1}"))
        await callback.message.edit_text(
            QUESTIONS[next_q]["text"],
            reply_markup=get_question_keyboard(next_q, show_back=True),
        )
    await callback.answer()


@dp.callback_query(TestStates.q1, F.data.startswith("answer_"))
async def q1_answer(callback: types.CallbackQuery, state: FSMContext):
    await process_answer(callback, state, 0, callback.data[-1])

@dp.callback_query(TestStates.q2, F.data.startswith("answer_"))
async def q2_answer(callback: types.CallbackQuery, state: FSMContext):
    await process_answer(callback, state, 1, callback.data[-1])

@dp.callback_query(TestStates.q3, F.data.startswith("answer_"))
async def q3_answer(callback: types.CallbackQuery, state: FSMContext):
    await process_answer(callback, state, 2, callback.data[-1])

@dp.callback_query(TestStates.q4, F.data.startswith("answer_"))
async def q4_answer(callback: types.CallbackQuery, state: FSMContext):
    await process_answer(callback, state, 3, callback.data[-1])

@dp.callback_query(TestStates.q5, F.data.startswith("answer_"))
async def q5_answer(callback: types.CallbackQuery, state: FSMContext):
    await process_answer(callback, state, 4, callback.data[-1])

@dp.callback_query(TestStates.q6, F.data.startswith("answer_"))
async def q6_answer(callback: types.CallbackQuery, state: FSMContext):
    await process_answer(callback, state, 5, callback.data[-1])

@dp.callback_query(TestStates.q7, F.data.startswith("answer_"))
async def q7_answer(callback: types.CallbackQuery, state: FSMContext):
    await process_answer(callback, state, 6, callback.data[-1])


@dp.callback_query(F.data == "back")
async def go_back(callback: types.CallbackQuery, state: FSMContext):
    current_state = await state.get_state()
    if not current_state:
        await callback.answer("–ù–µ–ª—å–∑—è –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥")
        return

    state_name = current_state.split(':')[-1]
    if not state_name.startswith('q'):
        await callback.answer("–û—à–∏–±–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏")
        return

    try:
        current_q_num = int(state_name[1:])
    except ValueError:
        await callback.answer("–û—à–∏–±–∫–∞")
        return

    if current_q_num <= 1:
        await callback.answer("–≠—Ç–æ –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å, –Ω–∞–∑–∞–¥ –Ω–µ–ª—å–∑—è")
        return

    prev_q_num = current_q_num - 1
    prev_state = getattr(TestStates, f"q{prev_q_num}")

    await state.set_state(prev_state)
    show_back = prev_q_num > 1
    await callback.message.edit_text(
        QUESTIONS[prev_q_num - 1]["text"],
        reply_markup=get_question_keyboard(prev_q_num - 1, show_back=show_back),
    )
    await callback.answer()


@dp.message()
async def handle_unknown(message: types.Message):
    await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.")


# --- –ù–ê–°–¢–†–û–ô–ö–ê –í–ï–ë–•–£–ö–û–í –î–õ–Ø RENDER ---
async def on_startup(app: web.Application):
    """–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±—Ö—É–∫–∞"""
    webhook_url = os.getenv("WEBHOOK_URL")
    if not webhook_url:
        raise ValueError("WEBHOOK_URL –Ω–µ –∑–∞–¥–∞–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
    await bot.set_webhook(webhook_url, drop_pending_updates=True)
    logging.info(f"‚úÖ –í–µ–±—Ö—É–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ {webhook_url}")


async def on_shutdown(app: web.Application):
    """–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ: —É–¥–∞–ª–µ–Ω–∏–µ –≤–µ–±—Ö—É–∫–∞"""
    await bot.delete_webhook()
    logging.info("üî¥ –í–µ–±—Ö—É–∫ —É–¥–∞–ª—ë–Ω")


async def handle_webhook(request: web.Request) -> web.Response:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥—è—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram"""
    try:
        update = types.Update(**await request.json())
        await dp.feed_update(bot, update)
        return web.Response(status=200)
    except Exception as e:
        logging.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
        return web.Response(status=500)


# –°–æ–∑–¥–∞—ë–º aiohttp –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
app = web.Application()
app.router.add_post('/webhook', handle_webhook)
app.on_startup.append(on_startup)
app.on_shutdown.append(on_shutdown)


# --- –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ---
if __name__ == "__main__":
    port = int(os.getenv("PORT", 8080))
    web.run_app(app, host="0.0.0.0", port=port)
